name: ce-requests
http:
  host: http://localhost:9000
phases:
  # Send data points
  - run:
      constantRate:
        usersPerSec: 50
        maxSessions: 200
        duration: 30s
        scenario:
          # TODO We need to record 202s and wait for all responses
          - sendDataPointsEvents:
              # TODO how do i put the timestamp in the ce-benchmarktimestamp header?
              - randomInt:
                  toVar: eventId
              - httpRequest:
                  POST: /
                  headers:
                    ce-id:
                      # Even if we have collisions here, it doesn't matter to eventing,
                      # BUT this might be used to record lost events somehow?
                      fromVar: eventId
                    ce-source: "http://hyperfoil-bench.com"
                    ce-type: "datapoint.hyperfoilbench"
                    ce-specversion: "1.0"
                    ce-benchmarktimestamp:
                      fromVar: abc
                    content-type: "application/json"
                  body: |
                    {
                       "foo" : "bar"
                    }
              - awaitAllResponses
  # Send stop signal after the run is done
  - sendStopSignal:
      constantRate:
        usersPerSec: 1
        duration: 10s
        maxIterations: 10
        startAfter: run
        scenario:
          - sendStopEvent:
              - httpRequest:
                  POST: /
                  headers:
                    ce-id: "abc"
                    ce-source: "http://hyperfoil-bench.com"
                    ce-type: "stop.hyperfoilbench"
                    ce-specversion: "1.0"

